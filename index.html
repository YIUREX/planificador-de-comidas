<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planificador de comidas</title>
  <style>
    :root {
      --header-bg: #333;
      --header-text: #fff;
      --header-bg-dark: #222;
    }

    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    header {
      background: var(--header-bg-dark);
      color: var(--header-text);
      padding: 1em;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
      cursor: text;
    }

    .controls {
      text-align: center;
      margin: 1em 0;
      padding: 0 1em;
    }

    .ver-resumen {
      text-align: center;
      margin-top: 1em;
    }

    .ver-resumen button {
      background-color: #333;
      color: white;
    }

    .settings-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: none;
      font-size: 28px;
      cursor: pointer;
      border: none;
    }

    .settings-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      padding: 1em;
      display: none;
      z-index: 200;
    }

    button {
      margin: 0.3em;
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
    }

    .table-wrapper {
      overflow-x: auto;
      margin: auto;
      max-width: 100%;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 700px;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 0.8em;
      vertical-align: top;
    }

    thead th, tbody th {
      background: var(--header-bg);
      color: var(--header-text);
      text-transform: uppercase;
    }

    td.filled {
      background-color: #fff8cc;
    }

    td .title {
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1em;
    }

    td .actions {
      margin-top: 0.4em;
      font-size: 0.9em;
    }

    .actions button:first-child {
      background-color: #6c757d;
      color: white;
    }

    .actions button:last-child {
      background-color: #dc3545;
      color: white;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-content {
      background: white;
      padding: 1em;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }

    .resumen {
      margin: 2em auto;
      max-width: 600px;
      background: white;
      padding: 1em;
      border: 1px solid #ccc;
    }

    ul { padding-left: 1.2em; }
    input[type="text"], input[type="color"] {
      width: 100%;
      margin-bottom: 0.5em;
      padding: 0.4em;
    }

    @media screen and (max-width: 600px) {
      td .title {
        font-size: 1.2em;
      }
      td .actions button {
        font-size: 1em;
      }
      .controls {
        font-size: 0.9em;
      }
      header h1 {
        font-size: 1.5em;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="tituloEditable" contenteditable="true" onblur="guardarTitulo()">Planificador de comidas</h1>
  </header>

  <div class="controls">
    <button onclick="cambiarSemana(-1)">←</button>
    <strong id="rangoSemana"></strong>
    <button onclick="cambiarSemana(1)">→</button>
  </div>

  <div class="table-wrapper">
    <table id="tablaComidas">
      <thead>
        <tr>
          <th>Franja/Día</th>
          <th>Lunes</th>
          <th>Martes</th>
          <th>Miércoles</th>
          <th>Jueves</th>
          <th>Viernes</th>
          <th>Sábado</th>
          <th>Domingo</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="ver-resumen">
    <button onclick="mostrarResumen()">Lista de la compra ↓</button>
  </div>

  <button class="settings-button" onclick="toggleSettings()">⚙️</button>
  <div class="settings-panel" id="settingsPanel">
    <label>Color de cabecera:</label>
    <input type="color" id="colorCabecera" onchange="cambiarColorCabecera(this.value)"/>
  </div>

  <script>
    const franjas = ["desayuno", "comida", "cena"];
    const dias = ["lunes", "martes", "miércoles", "jueves", "viernes", "sábado", "domingo"];
    let semanaActual = getStartOfWeek(new Date());

    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function formatoFecha(date) {
      return date.toISOString().split('T')[0];
    }

    function getDataSemana() {
      return JSON.parse(localStorage.getItem(formatoFecha(semanaActual))) || {};
    }

    function guardarDataSemana(data) {
      localStorage.setItem(formatoFecha(semanaActual), JSON.stringify(data));
    }

    function renderTabla() {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      const data = getDataSemana();

      franjas.forEach(franja => {
        const tr = document.createElement("tr");
        const th = document.createElement("th");
        th.textContent = franja;
        tr.appendChild(th);

        dias.forEach(dia => {
          const td = document.createElement("td");
          const comida = (data[dia] && data[dia][franja]) || {};
          const nombre = comida.nombre || "Sin definir";
          td.innerHTML = `
            <div class="title" onclick="abrirModal('${dia}', '${franja}')">${nombre}</div>
            <div class="actions">
              <button onclick="copiarComida('${dia}','${franja}')">Copiar</button>
              <button onclick="borrarComida('${dia}','${franja}')">Borrar</button>
            </div>
          `;
          if (nombre !== "Sin definir") td.classList.add("filled");
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      document.getElementById("rangoSemana").textContent =
        formatoFecha(semanaActual) + " → " +
        formatoFecha(new Date(semanaActual.getTime() + 6 * 86400000));
    }

    function cambiarSemana(delta) {
      semanaActual.setDate(semanaActual.getDate() + delta * 7);
      renderTabla();
    }

    function mostrarResumen() {
      const data = getDataSemana();
      const ingredientesSet = new Set();

      dias.forEach(dia => {
        franjas.forEach(franja => {
          const comida = data[dia]?.[franja];
          if (comida && Array.isArray(comida.ingredientes)) {
            comida.ingredientes.forEach(ing => ingredientesSet.add(ing.trim()));
          }
        });
      });

      const lista = document.createElement("ul");
      const contenedor = document.createElement("div");
      contenedor.className = "resumen";
      contenedor.innerHTML = `<h3>Lista de la compra</h3>`;

      const ingredientes = Array.from(ingredientesSet).sort();
      if (ingredientes.length === 0) {
        lista.innerHTML = "<li>No hay ingredientes registrados esta semana.</li>";
      } else {
        ingredientes.forEach(ing => {
          const li = document.createElement("li");
          li.textContent = ing;
          lista.appendChild(li);
        });
      }

      contenedor.appendChild(lista);
      const cerrar = document.createElement("button");
      cerrar.textContent = "Cerrar";
      cerrar.onclick = () => contenedor.remove();
      contenedor.appendChild(cerrar);

      document.body.appendChild(contenedor);
    }

    function abrirModal(dia, franja) {
      const nombre = prompt("Nombre del plato:");
      if (!nombre) return;
      const data = getDataSemana();
      if (!data[dia]) data[dia] = {};
      if (!data[dia][franja]) data[dia][franja] = {};
      data[dia][franja].nombre = nombre;
      guardarDataSemana(data);
      renderTabla();
    }

    function copiarComida(dia, franja) {
      const data = getDataSemana();
      const comida = data[dia]?.[franja];
      if (comida) {
        localStorage.setItem("comidaCopiada", JSON.stringify(comida));
        alert("Comida copiada. Haz clic en otra celda para pegar.");
      }
    }

    function borrarComida(dia, franja) {
      const data = getDataSemana();
      if (data[dia]) {
        delete data[dia][franja];
        guardarDataSemana(data);
        renderTabla();
      }
    }

    function toggleSettings() {
      const panel = document.getElementById("settingsPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    }

    function cambiarColorCabecera(color) {
      document.documentElement.style.setProperty("--header-bg", color);
      localStorage.setItem("colorCabecera", color);
    }

    function guardarTitulo() {
      const titulo = document.getElementById("tituloEditable").innerText;
      localStorage.setItem("tituloApp", titulo);
    }

    function cargarTitulo() {
      const titulo = localStorage.getItem("tituloApp");
      if (titulo) document.getElementById("tituloEditable").innerText = titulo;
    }

    function cargarColorCabecera() {
      const color = localStorage.getItem("colorCabecera");
      if (color) {
        document.documentElement.style.setProperty("--header-bg", color);
        document.getElementById("colorCabecera").value = color;
      }
    }

    cargarTitulo();
    cargarColorCabecera();
    renderTabla();
  </script>
</body>
</html>
