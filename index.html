<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planificador de comidas</title>
  <style>
    :root {
      --header-bg: #4a4a4a;
      --header-text: #f0f0f0;
      --header-bg-dark: #3a3a3a;
    }

    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    header {
      background: var(--header-bg-dark);
      color: var(--header-text);
      padding: 1em;
      text-align: center;
      transition: background-color 0.3s ease;
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
      cursor: text;
      transition: background-color 0.3s ease, color 0.3s ease;
      background: var(--header-bg);
      color: var(--header-text);
      padding: 0.2em 0.5em;
      border-radius: 4px;
      display: inline-block;
    }

    .controls {
      text-align: center;
      margin: 1em 0;
      padding: 0 1em;
      color: var(--header-text);
      background-color: var(--header-bg);
      transition: background-color 0.3s ease, color 0.3s ease;
      border-radius: 4px;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }

    .ver-resumen {
      text-align: center;
      margin-top: 1em;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }

    .ver-resumen button {
      background-color: #222;
      color: white;
      font-weight: bold;
      padding: 0.6em 1.2em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .ver-resumen button:hover {
      background-color: #444;
    }

    .settings-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: none;
      font-size: 28px;
      cursor: pointer;
      border: none;
      user-select: none;
      color: var(--header-bg-dark);
      transition: color 0.3s ease;
    }
    .settings-button:hover {
      color: #555;
    }

    .settings-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      padding: 1em;
      display: none;
      z-index: 200;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-radius: 8px;
      font-family: sans-serif;
      max-width: 220px;
    }

    .settings-panel label {
      display: block;
      margin-bottom: 0.3em;
      font-weight: 600;
    }

    select, input[type="color"] {
      width: 100%;
      margin-bottom: 1em;
      padding: 0.3em;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    button {
      margin: 0.3em;
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      user-select: none;
    }

    .table-wrapper {
      overflow-x: auto;
      margin: auto;
      max-width: 100%;
      max-width: 720px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
      background: white;
      padding: 0.3em;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 700px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 0.8em;
      vertical-align: top;
      font-weight: normal;
    }

    thead th, tbody th {
      background: var(--header-bg);
      color: var(--header-text);
      text-transform: uppercase;
      font-weight: 700;
      font-size: 0.95em;
      user-select: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    td.filled {
      background-color: #fff8cc;
      transition: background-color 0.3s ease;
    }

    td .title {
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2em;
      user-select: none;
      color: #222;
    }

    td .actions {
      margin-top: 0.4em;
      font-size: 0.9em;
    }

    .actions button:first-child {
      background-color: #007bff;
      color: white;
      margin-right: 0.3em;
      transition: background-color 0.3s ease;
    }

    .actions button:first-child:hover {
      background-color: #0056b3;
    }

    .actions button:last-child {
      background-color: #dc3545;
      color: white;
      transition: background-color 0.3s ease;
    }

    .actions button:last-child:hover {
      background-color: #a71d2a;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-content {
      background: white;
      padding: 1em;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }

    .resumen {
      margin: 2em auto;
      max-width: 600px;
      background: white;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    ul { padding-left: 1.2em; }

    /* Mensaje discreto para copia */
    #mensajeCopiado {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: #007bff;
      color: white;
      padding: 0.5em 1em;
      border-radius: 4px;
      font-family: sans-serif;
      font-size: 0.9em;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 210;
    }

    input[type="text"], input[type="color"], select {
      font-family: sans-serif;
    }

    @media screen and (max-width: 600px) {
      td .title {
        font-size: 1.3em;
      }
      td .actions button {
        font-size: 1em;
      }
      .controls {
        font-size: 0.9em;
        border-radius: 0;
      }
      header h1 {
        font-size: 1.4em;
      }
      .table-wrapper {
        min-width: 100%;
        max-width: 100%;
        padding: 0;
      }
      table {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="tituloEditable" contenteditable="true" onblur="guardarTitulo()">Planificador de comidas</h1>
  </header>

  <div class="controls">
    <button onclick="cambiarSemana(-1)">←</button>
    <strong id="rangoSemana"></strong>
    <button onclick="cambiarSemana(1)">→</button>
  </div>

  <div class="table-wrapper">
    <table id="tablaComidas">
      <thead>
        <tr>
          <th>Franja/Día</th>
          <th>Lunes</th>
          <th>Martes</th>
          <th>Miércoles</th>
          <th>Jueves</th>
          <th>Viernes</th>
          <th>Sábado</th>
          <th>Domingo</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="ver-resumen">
    <button id="btnListaCompra" onclick="mostrarResumen()">Lista de la compra ↓</button>
  </div>

  <button class="settings-button" onclick="toggleSettings()">⚙️</button>
  <div class="settings-panel" id="settingsPanel">
    <label for="colorCabecera">Color de cabecera:</label>
    <input type="color" id="colorCabecera" onchange="cambiarColorCabecera(this.value)" list="paletaColores" />
    <datalist id="paletaColores">
      <option value="#4a4a4a"></option>
      <option value="#5a5a5a"></option>
      <option value="#3a3a3a"></option>
      <option value="#6e7f80"></option>
      <option value="#8a9a9e"></option>
      <option value="#758a94"></option>
      <option value="#486674"></option>
      <option value="#355664"></option>
      <option value="#23343d"></option>
    </datalist>
  </div>

  <div id="mensajeCopiado">Comida copiada ✔️</div>

  <script>
    const franjas = ["desayuno", "comida", "cena"];
    const dias = ["lunes", "martes", "miércoles", "jueves", "viernes", "sábado", "domingo"];
    let semanaActual = getStartOfWeek(new Date());
    let mensajeTimeout = null;

    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function formatoFecha(date) {
      return date.toISOString().split('T')[0];
    }

    function getDataSemana() {
      return JSON.parse(localStorage.getItem(formatoFecha(semanaActual))) || {};
    }

    function guardarDataSemana(data) {
      localStorage.setItem(formatoFecha(semanaActual), JSON.stringify(data));
    }

    function renderTabla() {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      const data = getDataSemana();

      franjas.forEach(franja => {
        const tr = document.createElement("tr");
        const th = document.createElement("th");
        th.textContent = franja.toUpperCase();
        tr.appendChild(th);

        dias.forEach(dia => {
          const td = document.createElement("td");
          const comida = (data[dia] && data[dia][franja]) || {};
          const nombre = comida.nombre || "Sin definir";
          td.innerHTML = `
            <div class="title" onclick="abrirModal('${dia}', '${franja}')">${nombre}</div>
            <div class="actions">
              <button onclick="copiarComida('${dia}','${franja}')">Copiar</button>
              <button onclick="borrarComida('${dia}','${franja}')">Borrar</button>
            </div>
          `;
          if (nombre !== "Sin definir") td.classList.add("filled");
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      document.getElementById("rangoSemana").textContent =
        formatoFecha(semanaActual) + " → " +
        formatoFecha(new Date(semanaActual.getTime() + 6 * 86400000));
    }

    function cambiarSemana(delta) {
      semanaActual.setDate(semanaActual.getDate() + delta * 7);
      renderTabla();
    }

    function mostrarResumen() {
      // Evitar múltiples bloques resumen
      if(document.querySelector('.resumen')){
        document.querySelector('.resumen').remove();
      }

      const data = getDataSemana();
      const ingredientesSet = new Set();

      dias.forEach(dia => {
        franjas.forEach(franja => {
          const comida = data[dia]?.[franja];
          if (comida && Array.isArray(comida.ingredientes)) {
            comida.ingredientes.forEach(ing => ingredientesSet.add(ing.trim()));
          }
        });
      });

      const lista = document.createElement("ul");
      const contenedor = document.createElement("div");
      contenedor.className = "resumen";
      contenedor.innerHTML = `<h3>Lista de la compra</h3>`;

      const ingredientes = Array.from(ingredientesSet).sort();
      if (ingredientes.length === 0) {
        lista.innerHTML = "<li>No hay ingredientes registrados esta semana.</li>";
      } else {
        ingredientes.forEach(ing => {
          const li = document.createElement("li");
          li.textContent = ing;
          lista.appendChild(li);
        });
      }

      contenedor.appendChild(lista);
      const cerrar = document.createElement("button");
      cerrar.textContent = "Cerrar";
      cerrar.onclick = () => contenedor.remove();
      contenedor.appendChild(cerrar);

      document.body.appendChild(contenedor);
    }

    function abrirModal(dia, franja) {
      const nombre = prompt("Nombre del plato:");
      if (!nombre) return;
      const data = getDataSemana();
      if (!data[dia]) data[dia] = {};
      if (!data[dia][franja]) data[dia][franja] = {};
      data[dia][franja].nombre = nombre;
      guardarDataSemana(data);
      renderTabla();
    }

    function copiarComida(dia, franja) {
      const data = getDataSemana();
      const comida = data[dia]?.[franja];
      if (comida) {
        localStorage.setItem("comidaCopiada", JSON.stringify(comida));
        mostrarMensajeCopiado();
      }
    }

    function mostrarMensajeCopiado(){
      const mensaje = document.getElementById("mensajeCopiado");
      clearTimeout(mensajeTimeout);
      mensaje.style.opacity = "1";
      mensajeTimeout = setTimeout(() => {
        mensaje.style.opacity = "0";
      }, 2000);
    }

    function borrarComida(dia, franja) {
      const data = getDataSemana();
      if (data[dia]) {
        delete data[dia][franja];
        guardarDataSemana(data);
        renderTabla();
      }
    }

    function toggleSettings() {
      const panel = document.getElementById("settingsPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    }

    function cambiarColorCabecera(color) {
      document.documentElement.style.setProperty("--header-bg", color);
      document.documentElement.style.setProperty("--header-bg-dark", shadeColor(color, -25));
      localStorage.setItem("colorCabecera", color);
      // Cambiar fondo y color texto header y controles
      document.querySelector("header").style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue("--header-bg-dark").trim();
      document.querySelector("header h1").style.backgroundColor = color;
      document.querySelector("header h1").style.color = "#f0f0f0";
      document.querySelector(".controls").style.backgroundColor = color;
      document.querySelector(".controls").style.color = "#f0f0f0";
    }

    // Función para oscurecer o aclarar color HEX
    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1,3),16);
      let G = parseInt(color.substring(3,5),16);
      let B = parseInt(color.substring(5,7),16);

      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);

      R = (R<255)?R:255;  
      G = (G<255)?G:255;  
      B = (B<255)?B:255;  

      const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
      const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
      const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

      return "#"+RR+GG+BB;
    }

    function guardarTitulo() {
      const titulo = document.getElementById("tituloEditable").innerText;
      localStorage.setItem("tituloApp", titulo);
    }

    function cargarTitulo() {
      const titulo = localStorage.getItem("tituloApp");
      if (titulo) document.getElementById("tituloEditable").innerText = titulo;
    }

    function cargarColorCabecera() {
      const color = localStorage.getItem("colorCabecera");
      if (color) {
        cambiarColorCabecera(color);
        document.getElementById("colorCabecera").value = color;
      }
    }

    cargarTitulo();
    cargarColorCabecera();
    renderTabla();
  </script>
</body>
</html>
